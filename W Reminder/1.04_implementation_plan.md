# v1.04 Implementation Plan: Cloud Sync & Data Robustness

**Objective:**
Implement a robust cloud synchronization system using Supabase, ensuring data consistency across devices, preventing crashes related to deleted objects, and providing a seamless "Guest" to "Registered User" transition.

## Core Features

### 1. Cloud Infrastructure (Supabase)
- [x] **Database Schema**:
    - `profiles`: Stores user settings (theme, sound), gamification stats (XP, level, streak), and account details.
    - `tags`: Stores user-defined tags.
    - `simple_checklists`: Stores simple tasks (title, due date, status, etc.).
    - `checklist_tags`: Junction table for M:N relationship between checklists and tags.
    - `milestones`: Stores milestone projects.
    - `milestone_items`: Stores sub-tasks for milestones.
    - `milestone_tags`: Junction table for M:N relationship between milestones and tags.
- [x] **Row Level Security (RLS)**:
    - Policies to ensure users can only access their own data (`auth.uid() = user_id`).
    - Policies for `profiles` to allow public read (for potential social features) but strictly private write.

### 2. Authentication & Session Management
- [x] **Login/Signup UI**:
    - Brand new `LoginView` with "Sign In", "Sign Up", and "Google OAuth" support.
    - "Welcome Back" animated overlay using the app's signature style.
- [x] **Guest Mode Support**:
    - Users can start without an account (local-only data).
    - Upon logging in, users are prompted to **Merge** their local guest data with their cloud account or **Delete** it to start fresh.
- [x] **Session Handling**:
    - Automatic session restoration at launch.
    - Secure storage of tokens.

### 3. Synchronization Engine (`SyncManager`)
- [x] **Two-Phase Sync**:
    - **Push**: Uploads local changes (Payload approach) to the cloud.
    - **Pull/Merge**: Fetches cloud data and merges it into the local SwiftData store.
- [x] **Conflict Resolution**:
    - **Timestamp Wins**: The most recently updated record (User vs Cloud) wins.
    - **Anti-Ghosting**: Prevents "resurrection" of locally deleted items by tracking deleted IDs in a `DeletedRecord` table.
- [x] **Robustness**:
    - **Sync Buffer**: Handles rapid-fire updates (e.g., checking multiple tasks quickly) by queuing sync requests, preventing data loss.
    - **Ghost Object Fix**: Refactored `State` variables to store IDs (`UUID`) instead of Objects to prevent crashes when background sync deletes items.

### 4. UI/UX Enhancements
- [x] **App Version Control**:
    - Forces users to update if their client version is older than the `min_supported_version` in Supabase.
- [x] **Gamification**:
    - Synced XP, Levels, and Streaks across devices.
    - "Welcome Back" popup plays the signature sound only on actual login interaction.
- [x] **Animations**:
    - Auto-scroll to new sub-tasks in Milestones.
    - Smooth transitions for "Add Task" sheets.

## Technical Improvements
- Refactored `Tag` filtering to use UUIDs to eliminate "Fatal error: Accessing deleted object".
- Unified `TimeInterval` logic for reliable "Time Remaining" displays.
- Updated Widget bundle version to match main app (`1.04`).

## Testing Status
- [x] **Sync Logic**: Verified push/pull and merge scenarios.
- [x] **Deletion**: Verified deleting items on one device removes them on another.
- [x] **Ghost Objects**: Verified no crashes when filtering by a tag that gets deleted in background.
- [x] **Guest Migration**: Verified merging guest data into a new account works.
- [x] **Version Check**: Verified app blocks usage if version < minimum.
